{% extends "base.html" %}
{% load form_display %}

{% block marking_header_extra %}
<script type="text/javascript">//<![CDATA[
function append_problem(n, penalty, content, outof) {
  // handle comment
  var comment = $("#id_cmp-" + n + "-comment");
  var text = comment.val();
  if ( text != "" ) { text += "; " }
  text += content;
  comment.val(text);
  
  // handle mark
  var value = $("#id_cmp-" + n + "-value");
  if ( penalty == 0 ) { return; }
  mark = parseFloat(value.val());
  if ( isNaN(mark) || mark==0 ) {
    // logic: negative penalty must mean we're marking from 0 up; positive from max mark down.
    if ( penalty<0 ) {
      mark = 0.0;
    } else {
      mark = outof;
    }
  }
  mark -= penalty;
  value.val(mark);
}
//]]></script>
{% endblock%}

{% block title %}Marking: {% if student %}{{student.name}}{% else %}{{ group.name }}{% endif %}, {{activity.name}}{% endblock %}
{% block h1 %}Marking: {% if student %}{{student.name}}{% else %}{{ group.name }}{% endif %}, {{activity.name}}{% endblock %}

{% block subbreadcrumbs %}<li><a href="{% url "grades.views.course_info" course_slug=course.slug %}">{{ course.name }}</a></li>
<li><a href="{{ activity.get_absolute_url }}">{{activity.name}}</a></li>
<li>Mark {% if student %}{{student.name}}{% else %}{{ group.name }}{% endif %}</li>{% endblock %}

{% block content %}
     
<div id="marking_container">
<form action="" method="post" enctype="multipart/form-data">{% csrf_token %}
	 {% for entry in component_data %}
	     <fieldset>
	     <legend>{{entry.component.title}}</legend> 
		     <ul class="component">
		        <li>{{entry.component.description|linebreaks}}</li>
		        <li class="component_mark">
		        	Mark:
                    {{entry.form.value}} out of {{entry.component.max_mark}}
		        	{% if entry.form.value.errors %}
		        	{{entry.form.value.errors}}
		        	{% endif %}
		        </li>
		        <li class="common_problems">
			    {% with forloop.counter as pos %}
			    Common problems:    
			    <div>
			    {% for problem in entry.common_problems %}			    	
			        <input type="button" value="{{problem.title}}" title="{{problem.description}}{%if problem.penalty%} [penalty: {{problem.penalty}}]{%endif%}"
			        onclick="append_problem({{pos}}, {{problem.penalty}}, '{{problem.description|escapejs}}', {{entry.component.max_mark}});"/>
			    {% endfor %}
			    <a href="{% url "marking.views.manage_common_problems" course_slug=course.slug activity_slug=activity.slug%}" title="Manage common problems">Manage&hellip;</a>
			    </div>			    
			    {% endwith %}			    
			    </li>
		        <li class="component_comment">		    		      		 
		        	{{entry.form.comment.label_tag}} {{ entry.form.comment }}
		      		{% if entry.form.comment.errors %}		      		
		      		<div class="errortext"><img src="{{STATIC_URL}}icons/error.png" alt="error"/>&nbsp;{{entry.form.comment.errors.0}}</div>	        			      		
		      		{% endif %}		      				      	  	
				</li>			
		 	</ul>   	 
	  </fieldset>
     {% empty %}
	   	<p class="empty">Marking is not <a href="{% url "marking.views.manage_activity_components" course_slug=course.slug activity_slug=activity.slug %}" title="Edit components">configured</a>.
	    </p>
	 {% endfor %}
	 <fieldset>
	 <legend>Additional Information</legend>
     {{form|as_dl}}
     <p>
     <input class="submit" type="submit" name="mark" value="Submit" />
	 {% if not group %}
	   <input class="submit" type="submit" name="marknext" title="submit this form and mark next student (by userid)" value="Submit and mark next userid" />
	 {% endif %}
     </p>
	 </fieldset>
</form>
</div>

{% endblock %}
