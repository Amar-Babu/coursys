{% extends "base.html" %}
{% load form_display %}

{% block title %}{{ application.posting.unit.label }} TA Application for {{application.person}}{% endblock %}
{% block h1 %}{{ application.posting.unit.label }} TA Application for {{application.person}}{% endblock %}
{% block content %}

<script type="text/javascript">	
	function calculate(){
		var total = 0;
		for(var i = 0; i < 3; i++){
			val = parseFloat($('#id_tacourse_set-' + i + '-bu').val())
			if(val > 0)
				total += val
		}
		$('#total_bu').val(total.toFixed(2))   
		
		var salary_rate = parseFloat($('#id_pay_per_bu').val())
		var schol_rate = parseFloat($('#id_scholarship_per_bu').val())
		var bu = parseFloat($('#total_bu').val())
		var salary_sem = (bu * salary_rate).toFixed(2)
		var schol_sem = (bu * schol_rate).toFixed(2)
		$('#salary_sem').val(salary_sem)
		$('#schol_sem').val(schol_sem)
		var salary_bi = (salary_sem / "{{posting.payperiods}}").toFixed(2)
		var schol_bi = (schol_sem / "{{posting.payperiods}}").toFixed(2)
		$('#salary_bi').val(salary_bi)
		$('#schol_bi').val(schol_bi)
	}
	
	function validate(cat){
		$('#messages').hide()
		if($('#messages ul.errorlist').html!='')
			$('#messages ul.errorlist').html("")
		var valid = true
		var html = ""
		
		if(cat==true){
			if($('#id_appt_category').val()==""){
				html += '<li class="warning">Please select an appointment category</li>'
				valid = false
			}
		}
		var clist = new Array()
		$('.course_select').each(function(){
			if($(this).val()!="")
				clist.push($(this).val())
		})	

		if(!check_dup(clist.sort())){
			html += '<li class="warning">Duplicate course selection</li>'
			valid = false
		}
			
    	if(html!=""){
    		$('#messages ul.warninglist').html(html)
    		$('#messages').show()
    	}
    	return valid;
	}
	
	function check_dup(list){
		for(var i = 0; i< list.length-1; i++){
			if(list[i]==list[i+1])
				return false
		}
		return true
	}
	
	//ajax to get default rates
	function set_rates(cat){
		$.post("{% url ta.views.edit_contract post_slug=posting.slug userid=userid %}",
			{'csrfmiddlewaretoken': "{{csrf_token}}", 'appt_cat': cat},
			function(data){
				$('#id_pay_per_bu').val(data.split(',')[0])
				$('#id_scholarship_per_bu').val(data.split(',')[1])
				if($('#salary_bi').val()!="")
					calculate()
			}); 
	}
		
    $(document).ready(function() {
    	$('#id_pay_start').datepicker({'dateFormat': 'yy-mm-dd'});
    	$('#id_pay_end').datepicker({'dateFormat': 'yy-mm-dd'});
    	$('#id_deadline').datepicker({'dateFormat': 'yy-mm-dd'});
    	
    	if(!('{{formset.non_form_errors}}'))
    		$('#messages').hide()
    	else
    		$('.errorlist li').attr('class','error')
 		
 		//ajax to get default appt_cat and sin for an application
 		/*
 		$('#id_applicant').change(function(){
 			aid = $('#id_applicant').val()
 			if(aid != ''){//nonempty selection
				$.post("{% url ta.views.edit_contract post_slug=posting.slug userid=userid %}",
				{'csrfmiddlewaretoken': "{{csrf_token}}", 'applicant': aid},
				function(data){
					if(data.length > 0){
						$('#id_sin').val(data.split(',')[0])
						$('#id_appt_category').val(data.split(',')[1])
						set_rates(data.split(',')[1])
					}
					else{
						$('#id_sin').val('')
						$('#id_appt_category').val('')
					}
				})
			}
 		})*/
 		
			
 		//ajax to get default required BU
		$('.course_select').change(function(){
			if(!validate(false))
				return
			var cid = $(this).val()
			var bu_inp = '#' + this.id.replace('-course','-bu')
			var desc_sel = '#' + this.id.replace('-course','-description')
			if(cid != ''){//nonempty selection
				$.post("{% url ta.views.edit_contract post_slug=posting.slug userid=userid%}",
				{'csrfmiddlewaretoken': "{{csrf_token}}", 'course': cid},
				function(data){
					var val = parseFloat(data.split(',')[0])
					$(desc_sel).val(data.split(',')[1])
					$(desc_sel).data('orig', $(desc_sel).val())
					if($(desc_sel).val()=='OML')
						val += 0.17
					$(bu_inp).val(val.toFixed(2))
				})
			}
			else{
				$(bu_inp).val(0)
				$(desc_sel).val('')
			}
    	})
    	
    	//retain old values for course description select
    	$('.desc_select').each(function(){
    		$(this).data('orig', $(this).val())
    	})
    	//deal with course description change
    	$('.desc_select').change(function(){
    		var cid = $(this).val()
			var course_sel = '#' + this.id.replace('-description','-course')
			var bu_inp = '#' + this.id.replace('-description','-bu')
			if(cid == 'OML' && $(bu_inp).val() != '' ){
				//validate bu value is positive number
				val = $(bu_inp).val()
				//if(!isNaN(val))
				$(bu_inp).val((parseFloat(val) + 0.17).toFixed(2))
			}
			else if($(this).data('orig') == 'OML' && $(bu_inp).val() != ''){
				//validate bu value is positive number
				val = $(bu_inp).val()
				if(!isNaN(val) && parseFloat(val) >= 0.17)
					$(bu_inp).val((parseFloat(val) - 0.17).toFixed(2))
			}
			$(this).data('orig', $(this).val())
    	})

    	
    	//setting rates per bu based on appt category
    	/*
    	if($('#id_appt_category').val() != "")
    		set_rates($('#id_appt_category').val())
    	else if($('#salary_sem').val()=="")
    		$('#id_appt_category').val("")
    	*/
    		
    	$('#id_appt_category').change(function(){
    		var cat = $(this).val()
    		if(cat!='')
    			set_rates(cat)
    	})
    	
    	//calcuate event
    	$('#button_cal').click(function(){
    		if(validate(true))
    			calculate()
    	})
    });
</script>


<div class="table_container">
  <h2>General Information:</h2> 
  <table class="info">
    <tr><th>Name</th><td>{{ application.person.name }}</td></tr>
    <tr><th>Semester</th><td>{{ application.posting.semester }}</td></tr>
    <tr><th>Category</th><td>{{ application.get_category_display }}</td></tr>
    <tr><th>Base Units</th><td>{{ application.base_units }}</td></tr>
    <tr><th>Experience</th><td>{{ application.experience }}</td></tr>
    <tr><th>Course Load</th><td>{{ application.course_load }}</td></tr>
    <tr><th>Other Support</th><td>{{ application.other_support }}</td></tr>
    <tr><th>Comments</th><td>{{ application.comments }}</td></tr>
  </table>
  
  <h2>Courses Applied for:</h2>
  <table class="info">
    <tr>
      <th>Course</th>
      <th>Taken</th>
      <th>Experience</th>
    </tr>
    <tr>
      {% for course in courses %}
        <tr>
          <td>{{ course.course }}</td>
          <td>{{ course.get_taken_display }}</td>
          <td>{{ course.get_exper_display }}</td>
        </tr>
      {% endfor %}
    </tr>
   </table>

 
  <table class="info">
    <h2>Campus Preference:</h2> 
    <tr>
      {% for campus in campuses %}
        <tr><th>{{ campus.get_campus_display }}</th><td>{{ campus.get_pref_display }}</td></tr>
      {% endfor %}
    </tr>
  </table>   
 
  {% if skills %}
  <table class="info">
    <h2>Skills:</h2>
    <tr>
      {% for skill in skills %}
        <tr><th>{{ skill.skill.name }}</th><td>{{ skill.get_level_display }}</td></tr>
      {% endfor %}
    </tr>
  </table>
  {% endif %}
</div>
{% endblock %}
