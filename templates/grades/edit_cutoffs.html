{% extends "grades/base.html" %}
{% load grade_student %}

{% block h1 %}
Edit Cutoffs of {{ activity.name }}
{% endblock %}
{% block title %}
Edit Cutoffs of {{ activity.name }}
{% endblock %}

{% block grades_headextra %}
<link rel="stylesheet" href="{{MEDIA_URL}}visualize/css/visualize.css" type="text/css" />
<!--[if IE]><script type="text/javascript" src="{{MEDIA_URL}}visualize/excanvas.compiled.js"></script><![endif]-->
<script type="text/javascript" src="{{MEDIA_URL}}visualize/visualize.jQuery.js"></script>
<script type="text/javascript">
//<![CDATA[
/**
 * Copyright (c) Mozilla Foundation http://www.mozilla.org/
 * This code is available under the terms of the MIT License
 */
if (!Array.prototype.filter) {
    Array.prototype.filter = function(fun /*, thisp*/) {
        var len = this.length >>> 0;
        if (typeof fun != "function") {
            throw new TypeError();
        }

        var res = [];
        var thisp = arguments[1];
        for (var i = 0; i < len; i++) {
            if (i in this) {
                var val = this[i]; // in case fun mutates this
                if (fun.call(thisp, val, i, this)) {
                    res.push(val);
                }
            }
        }

        return res;
    };
}


  var source_grades = {{source_grades}};
  var histo_cells;
  var letters = new Array('ap', 'a', 'am', 'bp', 'b', 'bm', 'cp', 'c', 'cm', 'd');
  function valof(id) {
    return parseFloat(document.getElementById("id_" + id).value);
  }
  function histotd(id) {
    return document.getElementById("histo_" + id);
  }

  $(document).ready(function() {
    var i;
    $("table.histo").hide();
    $("table.histo").visualize({'height': '300px', appendTitle: false, appendKey: false});
    histo_cells = new Array();
    for(var i in letters) {
      histo_cells.push(histotd(letters[i]));
    }
    histo_cells.push(histotd('f'));
    
    for(i=0; i<source_grades.length; i++) {
      source_grades[i] += 0.00000001;
    }
    recalculate_histo();
    
    $("#cutoffform").change(function() {
      recalculate_histo();
    });
    $("#offsetbutton").click(function() {
      apply_offset();
    });
  });
  
  function apply_offset() {
    var inp;
    var off = parseFloat(document.getElementById("id_offset").value);
    for(var i in letters) {
      inp = $("#id_"+letters[i]);
      inp.val(parseFloat(inp.val()) + off);
    }
  }

  function recalculate_histo() {
    var cutoffs = new Array();
    for(var i in letters) {
      cutoffs.push(valof(letters[i]));
    }
    cutoffs.push(0.0);
    
    var i, j, g;
    
    // create array of histogram counts
    counts = Array()
    for(i=0; i<histo_cells.length; i++) {
      counts.push(0);
    }
    for(i=0; i<source_grades.length; i++) {
      g = source_grades[i];
      for(j=0; j<cutoffs.length; j++) {
        if (g > cutoffs[j]) {
          counts[j] += 1;
          break;
        }
      }
    }
    
    // put counts into cells
    for(i=0; i<histo_cells.length; i++) {
      histo_cells[i].innerHTML = counts[histo_cells.length - i - 1];
    }
    $('.visualize').trigger('visualizeRefresh');
  }
//]]></script>
{% endblock %}

{% block subbreadcrumbs %}<li>&gt; <a href="{% url grades.views.course_info course_slug=course.slug %}">{{ course.name }}</a></li><li>&gt; <a href="{% url grades.views.activity_info course_slug=course.slug activity_slug=activity.slug%}">{{ activity.name }}</a></li><li>&gt; Edit cutoffs</li>{% endblock %}


{% block content %}
<br/>

<div id="form_container">
    {% if cutoff.non_field_errors %}
    {{ cutoff.non_field_errors }}
    {% endif %}
    
        <form action="{% url grades.views.edit_cutoffs course_slug=course.slug activity_slug=activity.slug %}"
                method="post" id="cutoffform">{% csrf_token %}
        <p class="cutoffoffset">Adjust all cutoffs: <input type="text" name="offset" value="0.0" size="4" id="id_offset" /><br /><input type="button" value="Add to each" id="offsetbutton" /></p>
        <fieldset>
        	<legend>Lower bounds for each grade</legend>
        		<ul><li>
        		<table class="cutoffs">
        		<tr>
        		<td class="label">Max</td><td><input type="text" value="{{activity.numeric_activity.max_grade}}" disabled="disabled" /></td>
        		</tr>
        		<tr>
        		<td class="label">A+</td><td>{{cutoff.ap}} {{cutoff.ap.errors}}</td>
        		<td class="label">A</td><td>{{cutoff.a}} {{cutoff.a.errors}}</td>
        		<td class="label">A-</td><td>{{cutoff.am}} {{cutoff.am.errors}}</td>
        		</tr>
        		
        		<tr>
        		<td class="label">B+</td><td>{{cutoff.bp}} {{cutoff.bp.errors}}</td>
        		<td class="label">B</td><td>{{cutoff.b}} {{cutoff.b.errors}}</td>
        		<td class="label">B-</td><td>{{cutoff.bm}} {{cutoff.bm.errors}}</td>
        		</tr>
        		
        		<tr>
        		<td class="label">C+</td><td>{{cutoff.cp}} {{cutoff.cp.errors}}</td>
        		<td class="label">C</td><td>{{cutoff.c}} {{cutoff.c.errors}}</td>
        		<td class="label">C-</td><td>{{cutoff.cm}} {{cutoff.cm.errors}}</td>
        		</tr>
        		
        		<tr>
        		<td class="label">D</td><td>{{cutoff.d}} {{cutoff.d.errors}}</td>
        		<td class="label">F</td><td><input type="text" value="0" disabled="disabled" /></td>
        		</tr>
        		</table></li>
				<li>
        				<input class="submit" type="submit" value="Submit" />
        			</li>
			</ul>
        </fieldset>
        </form>
</div>

		
<h2 id="histo">Live Histogram</h2>

<p>Note: N and DE grades are not calculated in this view; there may be roundoff problems here that are not present when you calculate actual grades.</p>
<table class="histo info" style="width: 500px; border-collapse: collapse;">
    <caption>Letter Grades</caption>
    
    <thead>
	<tr>
	    <td></td>
	    <th scope="col">F</th>
	    <th scope="col">D</th>
	    <th scope="col">C-</th>
	    <th scope="col">C</th>
	    <th scope="col">C+</th>
	    <th scope="col">B-</th>
	    <th scope="col">B</th>
	    <th scope="col">B+</th>
	    <th scope="col">A-</th>
	    <th scope="col">A</th>
	    <th scope="col">A+</th>
	</tr>
    </thead>
    <tbody>
	<tr>
	    <th scope="row">Grade</th>
	    <td id="histo_ap">0</td>
	    <td id="histo_a">0</td>
	    <td id="histo_am">0</td>
	    <td id="histo_bp">0</td>
	    <td id="histo_b">0</td>
	    <td id="histo_bm">0</td>
	    <td id="histo_cp">0</td>
	    <td id="histo_c">0</td>
	    <td id="histo_cm">0</td>
	    <td id="histo_d">0</td>
	    <td id="histo_f">0</td>
	</tr>
    </tbody>
    

</table>
{% endblock %}
