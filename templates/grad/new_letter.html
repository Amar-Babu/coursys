{% extends "base.html" %}
{% load markup %}
{% load mobile_tags %}
{% load form_display %}

{% block title %}New Letter for {{grad.person.last_name}}, {{grad.person.first_name}}{% endblock %}
{% block h1 %}New Letter for {{grad.person.last_name}}, {{grad.person.first_name}}{% endblock %}

{% block subbreadcrumbs %}
<li>
	&gt; <a href="{% url grad.views.index %}">Grad</a>
</li>
<li>
	&gt; <a href="{% url grad.views.view_all grad_slug=grad.slug %}">{{grad.person.last_name}}, {{grad.person.first_name}}</a>
</li>
<li>
	&gt; {{crumb}}
</li>
{% endblock %}
{% block headextra %}
<script type="text/javascript">
	function getData(url) {
		$.ajax({
			type : "GET",
			url : url,
			success : function(data) {
				$("#id_content").append(data);
			}
		})
	}

	function update_from_lines() {
        if ($('#id_from_person').val() == '' ) {
            $("#id_from_lines").val('');
        } else { 
            var label = $("#id_from_person option:selected").text();
            var lines = label.split(", ");
            var from = lines.join("\r\n");
            $("#id_from_lines").val(from);
        }
	}

	var address_map = {};
	function update_to_lines() {
		var label = $("#id_address").val();
		$("#id_to_lines").val(address_map[label]);
	}

	function get_addresses(url) {
		// insert widget into form
		var prev = $('#id_date').parent().parent();
		var element = '<dt><label for="id_address">Addresses:</label></dt><dd><div class="field">';
		element += '<select id="id_address"><option value="none">&mdash;</option></select>';
		element += '<img src="{{MEDIA_URL}}icons/ajax-loader.gif" alt="..." id="fetchwait" /></div>';
		element += '<div class="helptext">Known addresses for the student</div></dd>';
		prev.after(element)
		var id = $('#id_student').val();
		$.ajax({
			type : 'GET',
			url : url + '?id=' + id,
			error : function(data) {
				$("#fetchwait").hide();
			},
			success : function(data) {
				if(data.error !== undefined) {
					$("#fetchwait").after(' <span class="empty">Error: ' + data.error + '</span>');
					$("#fetchwait").hide();
				}
				if(data.addresses.mail !== undefined) {
					addr = data.addresses.mail;
					address_map['mail'] = addr;
					$("#id_address").append('<option value="mail">Mailing address: ' + addr.split('\n').join(', ') + '</option>')
				}
				if(data.addresses.home !== undefined) {
					addr = data.addresses.home;
					address_map['home'] = addr;
					$("#id_address").append('<option value="home">Home address: ' + addr.split('\n').join(', ') + '</option>')
				}
				$("#fetchwait").hide();
				$("#id_address").change(update_to_lines);
			}
		});
	}


	$(document).ready(function() {
		$('#id_content').attr("disabled", "disabled");
		$("#id_date").datepicker({
			'dateFormat' : 'yy-mm-dd'
		});
		$('#content_note').show('slow');
		urlMap = {
		{% for k in templates %}
		'{{k.id}}' : '{% url grad.views.get_letter_text grad_slug=grad.slug letter_template_id=k.id %}'
		{% if not forloop.last %},{% endif %}
		{% endfor %}
		};

		get_addresses('{% url grad.views.get_addresses %}')

		$("#id_template").change(function() {
			var template_val
			template_val = $("#id_template").val();
			$("#id_content").empty();
			if(template_val == 0) {
				$('#id_content').attr("disabled", "disabled");
				$('#content_note').show('slow');
			} else {
				url = urlMap[$(this).val()];
				$('#id_content').removeAttr("disabled");
				$('#content_note').hide('slow');
				getData(url);
			}
		});

		$("#id_from_person").change(update_from_lines);
		update_from_lines();
	});

</script>
{% endblock %}
{% block content %}
<div id="form_container">
	<form action="{% url grad.views.new_letter grad_slug=grad.slug%}" method="post">
		{% csrf_token %}
		<fieldset>
			<legend>
				Letter Info
			</legend>
			{{ form.non_field_errors }}
			<dl class="dlform">
				<dt>
					<label>Template:</label>
				</dt>
				<dd>
					<div class="field">
						<select name="template" id="id_template">
							<option value=0> --- Pick an existing template --- </option>
							{% for t in templates%} <option value={{t.id}}>{{t.label}}</option>
							{% endfor %}
						</select>
						{{form.template.errors}}
						<div style="color: red; font-weight: normal; float: right; margin-right: 200px;" id="content_note">
						< Please select a template.
					</div>
					</div>

				</dd>
			</dl>
			<div style="clear: both"></div>
			{{form|as_dl_excludefields:"template"}}
			<p>
				<input  class="submit"  type="submit" value="Submit" />
			</p>
		</fieldset>
	</form>
	<a class="button" href="{% url grad.views.index %}">Back</a>
</div>
{% endblock %} 